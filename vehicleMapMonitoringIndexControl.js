var vehicleMapMonitoringIndexControl = {	clickTypeInfo : {		type : 'dept',		id : ac.deptId,		root : ac.deptId	},	fenceList : null,	trajectoryRunning : null,	timer : null,	isSearched : false,	setHeight : function(){		$('#mapParent').css('height',(clientHeight - 60) + "px");		$('#mapParent').parent('div .row-fluid').css('height',(clientHeight - 60) + "px");		alert(clientHeight + 800+"|14");		$('#playDiv').css('top',(clientHeight - 20) + "px");//25		$('#treeParentDiv').css('height',(clientHeight - 71) + "px");		$('#searchTableDiv').css('height',(clientHeight - 169) + "px");		$('#workPlanTableParentDiv').css('height',(clientHeight - 234) + "px");		$('#historyWorkPlanTableParentDiv').css('height',(clientHeight - 309) + "px");	},	init : function(){		//this.initFenceBtnEvent();		window.clientHeight = document.body.clientHeight;		window.clientWidth = document.body.clientWidth;;		this.setHeight();		this.initTree();		this.initLineColorControlEvent();		this._setSpeedScaleArr();		this._initTimeBarBtn();		this._initSearchBtn();		this._initLiClick();		this._initHistorySelectDateDiv("historySelectDateDiv");		vehicleMapMonitoringIndexMapModule.initMap("mapParent");	},	_initHistorySelectDateDiv : function(divId){		WdatePicker({dateFmt:'yyyy-MM-dd',maxDate:'%y-%M-{%d-1}',eCont:divId,onpicked:function(dp){			window.historyDate = dp.cal.getDateStr();			vehicleMapMonitoringIndexControl.showVehicleDrivingTrajectoryHistory(vehicleId,deviceCode,historyDate);		}});		$(".wdatePickerParentDiv>iframe").css({width: (clientWidth * 0.22) + 'px',height:'175px',margin: '3px 2px 2px 2px'});//		$("#historyDateLi").click(function(){//			var wdateWidth = (clientWidth * 0.218) + 'px';//			$(window.frames[0].document).find(".WdateDiv").css({width:wdateWidth,height:'170px'});//			$(window.frames[0].document).find(".WdayTable").css({width:wdateWidth,height:'145px'});//		});	},	_initSearchBtn : function(){		$("#searchForm").validationEngine();			$("#searchBtn").click(function(){			if($("#searchForm").validationEngine('validate')){				var data = {};				data[$('#searchKey').val()]  = $('#searchValue').val().trim();				//alert(jsonToString(data));return;				$("#searchTableDiv").html('<div class="noDateForSearch">努力加载中...</div>');				$.post(					ctx + '/monitoringModule/vehicleMapMonitoring/getSearchDataList.do',					data,					function(data){						function handlerUndefinedValue(value){							if(value == undefined){								return '暂无';							}							return value;						}						if(data.states == 200){							var html = new Array();							//vehicleMapMonitoringIndexControl.vehicleClick(\'{vehicleId}\',\'search\')							html.push('<div class="mapMonitorBoxBorder-unselect" onclick="vehicleMapMonitoringIndexControl.vehicleClick(\'{vehicleId}\',\'{deptId}\',\'search\')">');							html.push('	<div class="mapMonitorBox">');							html.push('		<div class="mapMonitorBoxTitle {titleColor}">');							html.push('			<div class="mapMonitorBoxTitleNo"><img src="{carStateImgSrc}" width="50" height="50" /></div>');							html.push('			<div class="mapMonitorBoxTitleText">{vehicleCode}</div>');							html.push('		</div>');							html.push('		<div class="mapMonitorBoxContent">');							html.push('			<div class="mapMonitorBoxContentSquare">');							html.push('				<div class="{driverStateCls}"></div>');							html.push('				<div style="width: 100%;">{driverName}</div>');							html.push('			</div>');							html.push('			<div class="mapMonitorBoxContentSquare">');							html.push('				<div class="{carWorkStateCls}"></div>');							html.push('			<div style="width: 100%;">{carWorkStateStr}</div>');							html.push('			</div>');							html.push('			<div class="mapMonitorBoxContentSquare">');							html.push('				<div class="{carStateCls}"></div>');							html.push('				<div style="width: 100%;">{carState}</div>');							html.push('			</div>');							html.push('		</div>');							html.push('	</div>');							html.push('</div>');							html = html.join('');							var dataArr = data.dataArr								insertHtml = new Array();							for(var i=0;i < dataArr.length;i++){								var data = dataArr[i];								//alert(jsonToString(data));								var tempHtml = html.format({									vehicleId : data.vehicleId,									deptId : data.deptId,									carStateImgSrc : (ctx + (data.accState == 'ON' ? '/img/nopic.png' : '/img/off.png')),									titleColor : data.accState == 'ON' ? 'carOn' : 'carOff',									vehicleCode : handlerUndefinedValue(data.vehicleCode),									driverStateCls : data.driverName != undefined ? 'mapMonitorBoxContentHaveDriver' : 'mapMonitorBox2ContentNoHaveDriver',									driverName : handlerUndefinedValue(data.driverName),									carWorkStateCls : data.attendState == '6' ? 'mapMonitorBoxContentCarOn' : 'mapMonitorBox2ContentCarOff',									carWorkStateStr : data.attendState == '6' ? '出勤' : '未出勤',									carStateCls : data.vheicleState == '1' ? 'mapMonitorBoxContentOptionOn' : (data.vheicleState == '2' ? 'mapMonitorBox2ContentOptionOff' : 'mapMonitorBox3ContentOptionFault'),									carState : data.vheicleState == '1' ? '正常' : (data.vheicleState == '2' ? '停运' : '故障')								});								insertHtml.push(tempHtml);							}							if(insertHtml.length == 0){								insertHtml.push('<div class="noDateForSearch">努力搜索后，发现空空如也。</div>');							}							$("#searchTableDiv").html(insertHtml.join(''));							$("#searchTableDiv .mapMonitorBoxBorder-unselect").click(function() {								$("#searchTableDiv .mapMonitorBoxBorder-unselect").removeClass("mapMonitorBoxBorder-select");								$(this).addClass("mapMonitorBoxBorder-select");							})						}else{							alertMessage("查询车辆信息出错，请联系管理员！",0);						}					},					'json'				);			}		});	},	_setSpeedScaleArr : function(){		var speedScaleArr = $("#range_1").val().split(';');		vehicleMapMonitoringIndexMapModule.setSpeedScaleArr(speedScaleArr);	},	initLineColorControlEvent : function(){		$("#lineColorControl").click(function(){			$('#lineColorControlDiv').animate( {'top' : 36}, 'slow');		});		$("#lineColorControlOkBtn").click(function(){			vehicleMapMonitoringIndexControl._setSpeedScaleArr();			vehicleMapMonitoringIndexControl.showDrivingTrajectorySpeedScale();			vehicleMapMonitoringIndexMapModule.clearOverlays();			vehicleMapMonitoringIndexControl.trajectoryRunning.reset();			$('#lineColorControlDiv').animate( {'top' : -225}, 'slow');		});		$("#lineColorControlCancelBtn").click(function(){			$('#lineColorControlDiv').animate( {'top' : -225}, 'slow');		});	},	handlerMapOverlay : function(){		$.ajax({			url : ctx + '/monitoringModule/vehicleMapMonitoring/getPieChartDateAndVehicleInfo.do',			type : 'POST',			data : {parDeptId : this.clickTypeInfo.id},			dataType : 'JSON', 			cache : false,//				async : false,			beforeSend : function(){				showPicture();			},//				complete : function(){//					//				},			success : function(data){				function handlerMapTitleCount(pieChartArr,vehicleInfoArr){					var countCarFault = 0,countCarOff = 0,countCarOn = 0;					for(var i in pieChartArr){						var pieChartData = pieChartArr[i];						if(pieChartData.countCarFault != undefined)countCarFault += pieChartData.countCarFault;						if(pieChartData.countCarOff != undefined)countCarOff += pieChartData.countCarOff;						if(pieChartData.countCarOn != undefined)countCarOn += pieChartData.countCarOn;					}					for(var i in vehicleInfoArr){						var carMapInfo = vehicleInfoArr[i];						if(carMapInfo.state == 4){//故障状态							countCarFault++;						}else{							if(carMapInfo.accState == 'ON'){								countCarOn++;							}else{								countCarOff++;							}						}					}					var countDivs = $("#mapTitle>div:gt(0)");					var countCarOnDiv = countDivs.eq(0);					countCarOnDiv.find("div").css("background-color","#28b779")					countCarOnDiv.find("label").html('点火('+countCarOn+')');					var countCarOffDiv = countDivs.eq(1);					countCarOffDiv.find("div").css("background-color","#868686")					countCarOffDiv.find("label").html('熄火('+countCarOff+')');					var countCarFaultDiv = countDivs.eq(2);					countCarFaultDiv.find("div").css("background-color","#da542e")					countCarFaultDiv.find("label").html('停运('+countCarFault+')');				}				if(data.states == 200){					var pieChartArr = data.pieChartArr;					var vehicleInfoArr = data.vehicleInfoArr;					vehicleMapMonitoringIndexMapModule.clearOverlays();					var isSetCenter = vehicleMapMonitoringIndexMapModule.createPieChartOverlay(pieChartArr);					vehicleMapMonitoringIndexMapModule.createCarMaker(vehicleInfoArr,isSetCenter);					handlerMapTitleCount(pieChartArr,vehicleInfoArr);				}else{					alertMessage("查询机构车辆信息出错，请联系管理员！",0);				}				closePicture();			}		});	},	deptClick : function(deptId){		//$("#fence").css('display','');//		showPicture();		clearTimeout(vehicleMapMonitoringIndexControl.timer);		vehicleMapMonitoringIndexControl.isSearched = false;		var clickTypeInfo = this.clickTypeInfo;		clickTypeInfo.type = 'dept';		clickTypeInfo.id = deptId;		this.handlerMapOverlay();		this.isShowUpstairsBtn();		this.openTreeNode();//		closePicture();		$("#lineColorControl").css('display','none');		$('#lineColorControlDiv').animate( {'top' : -225}, 'slow');		$('#mapParent').css('height',(clientHeight - 60) + "px");		$('#playDiv').animate( {'top' : (clientHeight - 25)}, 'slow');		$("#planDiv").addClass('display');		$("#notTimeDateLi").addClass('display');		$("#historyDateLi").addClass('display');		$("#mapTitle>div:gt(0)").removeClass('display');	},	vehicleClick : function(vehicleId,deptId,inType){		//showPicture();		clearTimeout(vehicleMapMonitoringIndexControl.timer);		var clickTypeInfo = this.clickTypeInfo;		clickTypeInfo.type = 'vehicle';		clickTypeInfo.id = deptId;		$.ajax({			url : ctx + '/monitoringModule/vehicleMapMonitoring/getVehicleInfoOfMap.do',			type : 'POST',			data : {vehicleId : vehicleId},			dataType : 'JSON', 			cache : false,//			async : false,			beforeSend : function(){				showPicture();			},//			complete : function(){//				//			},			success : function(data){				//alert("ajax success");				function handlerMapTitleCount(vehicleInfoArr){					var countCarFault = 0,countCarOff = 0,countCarOn = 0;					for(var i in vehicleInfoArr){						var carMapInfo = vehicleInfoArr[i];						if(carMapInfo.state == 4){//故障状态							countCarFault++;						}else{							if(carMapInfo.accState == 'ON'){								countCarOn++;							}else{								countCarOff++;							}						}					}					$("#countCarOn").html('点火('+countCarOn+')');					$("#countCarOff").html('熄火('+countCarOff+')');					$("#countCarFault").html('停运('+countCarFault+')');				}				vehicleMapMonitoringIndexMapModule.clearOverlays();				if(inType == 'search'){					$("#upstairsBtn").css('display','none');					vehicleMapMonitoringIndexControl.isSearched = true;				}else{					$("#upstairsBtn").css('display','');					vehicleMapMonitoringIndexControl.isSearched = false;				}				if(data.states == 200){					var vehicleInfoArr = data.vehicleInfoArr;					if(vehicleInfoArr && (vehicleInfoArr instanceof Array) && vehicleInfoArr.length > 0){						var carMapInfo = vehicleInfoArr[0];						vehicleMapMonitoringIndexMapModule.createCarMaker(vehicleInfoArr,false);						handlerMapTitleCount(vehicleInfoArr);						if(!isNotNull(carMapInfo.lng) && !isNotNull(carMapInfo.lat)){							alertMessage("定位车辆超时，请稍后再点击车辆卡牌信息定位该车辆。",0);						}					}else{						alertMessage("定位车辆超时，请稍后再查询该车辆位置。",0);					}				}else{					alertMessage("查询机构车辆信息出错，请联系管理员！",0);				}				closePicture();			}		});		//closePicture();		//alert("ajax end");		$('#mapParent').css('height',(document.body.clientHeight - 80) + "px");		$('#playDiv').animate( {'top' : (clientHeight - 25)}, 'slow');		$("#planDiv").addClass('display');		$("#notTimeDateLi").addClass('display');		$("#historyDateLi").addClass('display');		$("#mapTitle>div:gt(0)").addClass('display');	},	returnUpstairs : function(){		//$("#fence").css('display','');		$("#lineColorControl").css('display','none');		$('#lineColorControlDiv').animate( {'top' : -225}, 'slow');		$('#playDiv').animate( {'top' : (clientHeight - 25)}, 'slow');		$("#mapTitle>div:gt(0)").removeClass('display');		var clickTypeInfo = this.clickTypeInfo;		var id = clickTypeInfo.id;		if(clickTypeInfo.type == 'dept'){			var idSplitArr = id.split('_');			var newId = '';			for(var i=0; i<(idSplitArr.length - 1);i++){				newId +=  idSplitArr[i] + '_';			}			newId = newId.substring(0,newId.length - 1);			clickTypeInfo.id = newId;		}else{			clickTypeInfo.type = 'dept';		}		this.openTreeNode();		this.handlerMapOverlay();		this.isShowUpstairsBtn();	},	isShowUpstairsBtn : function(){		var clickTypeInfo = this.clickTypeInfo;		var upstairsBtn = $("#upstairsBtn");		if(clickTypeInfo.root == clickTypeInfo.id ){			upstairsBtn.css('display','none');		}else{			upstairsBtn.css('display','');		}	},	openTreeNode : function(){		var treeObj = $.fn.zTree.getZTreeObj("deptAdnVehcileTree");		var clickTypeInfo = this.clickTypeInfo;		var node = treeObj.getNodeByParam("id",clickTypeInfo.id, null);		if(node && !node.open)treeObj.expandNode(node);		if(node)treeObj.selectNode(node);	},	initFenceBtnEvent : function(){		$.ajax({			url : ctx + '/monitoringModule/vehicleMapMonitoring/getFenceInfoList.do',			type : 'POST',			data : {plantFormId : ac.platformId},			dataType : 'JSON', 			cache : false,			success : function(data){				if(data.states == 200){				}else{					alertMessage("查询机构车辆信息出错，请联系管理员！",0);				}			}		});		var showFenceBtn = $("#showFenceBtn");		showFenceBtn.change(function(){			var checked = showFenceBtn.attr('checked');			 //alert(checked == 'checked');			 if(checked == 'checked'){				 			 }		});	},	initTree : function(){		var treeSetting = {			view: {  		        selectedMulti: false,  		        showLine : true,		        showIcon : true,		        dblClickExpand: false		    },  			data: {				simpleData: {					enable: true,					idKey: "id",					pIdKey: "pId",					rootPId: "top"				}			},			async: {				type:"post",				enable: true,				url: ctx+"/monitoringModule/vehicleMapMonitoring/deptAdnVehcileTree.do",				autoParam:["id=parDeptId"]			}//			,callback : {//				beforeCollapse : function(treeId, treeNode){//					return false;//				},//				beforeExpand : function(treeId, treeNode){//					return false;//				}//			}		};				 $.post(			ctx+"/monitoringModule/vehicleMapMonitoring/deptAdnVehcileTree.do",			{parDeptId:"newTree"},			function(parentNodes){				var treeObj = $.fn.zTree.init($("#deptAdnVehcileTree"), treeSetting, parentNodes);				var node = treeObj.getNodeByTId("deptAdnVehcileTree_1");				if(node)treeObj.selectNode(node);			},			'json'		);	},	linkVehicleDrivingTrajectory : function(vehicleId,deviceCode,queryDate,planId){		function showLiDiv(index){			$('.nav-tabs li').eq(index).addClass("active").siblings().removeClass('active');			$(".tab-content .tab-pane").eq(index).addClass("active").siblings().removeClass('active');		}		$('#jerichotab_contentholder',parent.document).children('div[class=curholder]').attr('class', 'holder').css({ 'display': 'none' });		$("#jerichotabholder_0",parent.document).attr('class', 'curholder').css({ 'display': 'block' });		$(".tab_selected",parent.document).removeClass("tab_selected").addClass("tab_unselect");		$("#jerichotab_0",parent.document).removeClass("tab_unselect").addClass("tab_selected");		window.vehicleId = vehicleId;		window.deviceCode = deviceCode;		if(isNotNull(planId))window.planId = planId;		if(todayDate == queryDate){			this.showVehicleDrivingTrajectory(vehicleId,deviceCode);			showLiDiv(2);		}else{			window.historyDate = queryDate;			var historyDateSplitArr = historyDate.split('-');			window.frames[0].window.day_Click(parseInt(historyDateSplitArr[0]),parseInt(historyDateSplitArr[1]),parseInt(historyDateSplitArr[2]));			showLiDiv(3);		}	},	showDrivingTrajectorySpeedScale : function(){		var speedScaleArr = vehicleMapMonitoringIndexMapModule.getSpeedScaleArr();		var low = speedScaleArr[0];		var high = speedScaleArr[1];		var countDivs = $("#mapTitle>div:gt(0)");		var countCarOnDiv = countDivs.eq(0);		countCarOnDiv.find("div").css("background-color","#28b779")		countCarOnDiv.find("label").html('≦' + low + '(km/h)');		var countCarOffDiv = countDivs.eq(1);		countCarOffDiv.find("div").css("background-color","#1010fc")		countCarOffDiv.find("label").html('≧' + low + '和≦' + high + '(km/h)');		var countCarFaultDiv = countDivs.eq(2);		countCarFaultDiv.find("div").css("background-color","#da542e")		countCarFaultDiv.find("label").html('≧' + high + '(km/h)');	},	showVehicleDrivingTrajectoryHistory : function(vehicleId,deviceCode,queryDate){		var wdateWidth = (clientWidth * 0.218) + 'px';		$(window.frames[0].document).find(".WdateDiv").css({width:wdateWidth,height:'170px'});		$(window.frames[0].document).find(".WdayTable").css({width:wdateWidth,height:'145px'});		$.ajax({			url : ctx + '/monitoringModule/vehicleMapMonitoring/getVehicleDrivingTrajectoryHistory.do',			type : 'POST',			data : {				vehicleId : vehicleId,				deviceCode : deviceCode,				queryDate : queryDate			},			dataType : 'JSON', 			cache : false,			beforeSend : function(){				showPicture();			},			success : function(data){				if(data.states == 200){					vehicleMapMonitoringIndexControl.showDrivingTrajectorySpeedScale();					$("#mapTitle>div:gt(0)").removeClass('display');					$(window.frames[0].document).find(".WdateDiv").css({width:wdateWidth,height:'170px'});					$(window.frames[0].document).find(".WdayTable").css({width:wdateWidth,height:'145px'});					$("#vehicleCodeOfHistory").html(data.vehicleInfo.vehicleCode);					vehicleMapMonitoringIndexMapModule.clearOverlays();					window.vehicleId = vehicleId;					window.deviceCode = deviceCode;					//window.todayDate = data.todayDate;					vehicleMapMonitoringIndexMapModule.handlerDrivingTrajectoryDataArr(data.drivingTrajectoryPointList);					vehicleMapMonitoringIndexMapModule.setTrajectoryAlarmPointArr(data.drivingTrajectoryAlarmPointList);					$("#lineColorControl").css('display','inline');					$("#upstairsBtn").css('display','none');					$("#notTimeDateLi").removeClass('display');					$("#historyDateLi").removeClass('display');					vehicleMapMonitoringIndexControl._showTripTimeBar();					vehicleMapMonitoringIndexControl.drawingWorkPlanCardList('historyWorkPlanTableParentDiv',data.workPlanDataListHistory);					if(!isNotNull(planId)){						vehicleMapMonitoringIndexControl.trajectoryRunning = vehicleMapMonitoringIndexMapModule.drawingAllDrivingTrajectory();						vehicleMapMonitoringIndexControl._refreshTrackInfoDivInfo(vehicleId,deviceCode,queryDate+' 00:00:00',queryDate+' 23:59:59');					}					$("#lineColorControl").css('display','inline');					$("#upstairsBtn").css('display','none');				}else{					alertMessage("查询车辆轨迹信息出错，请联系管理员！",0);				}				closePicture();			}		});	},	showVehicleDrivingTrajectory : function(vehicleId,deviceCode){		$.ajax({			url : ctx + '/monitoringModule/vehicleMapMonitoring/getVehicleDrivingTrajectoryOfToday.do',			type : 'POST',			data : {				vehicleId : vehicleId,				deviceCode : deviceCode			},			dataType : 'JSON', 			cache : false,			beforeSend : function(){				showPicture();			},			success : function(data){				if(data.states == 200){					vehicleMapMonitoringIndexControl.showDrivingTrajectorySpeedScale();					$("#mapTitle>div:gt(0)").removeClass('display');					vehicleMapMonitoringIndexMapModule.clearOverlays();					window.vehicleId = vehicleId;					window.deviceCode = deviceCode;					//window.todayDate = data.todayDate;					vehicleMapMonitoringIndexMapModule.handlerDrivingTrajectoryDataArr(data.drivingTrajectoryPointList);					vehicleMapMonitoringIndexMapModule.setTrajectoryAlarmPointArr(data.drivingTrajectoryAlarmPointList);					$("#lineColorControl").css('display','inline');					$("#upstairsBtn").css('display','none');					$("#notTimeDateLi").removeClass('display');					$("#historyDateLi").removeClass('display');					vehicleMapMonitoringIndexControl._showTripTimeBar();					vehicleMapMonitoringIndexControl.refreshNowTimeInfo(data.nowTimeStatisticsDataVO,data.nowTimeWorkPlanDataList);					if(!isNotNull(planId)){						vehicleMapMonitoringIndexControl.trajectoryRunning = vehicleMapMonitoringIndexMapModule.drawingAllDrivingTrajectory();						vehicleMapMonitoringIndexControl._refreshTrackInfoDivInfo(vehicleId,deviceCode,todayDate+' 00:00:00',todayDate+' 23:59:59');					}				}else{					alertMessage("查询车辆轨迹信息出错，请联系管理员！",0);				}				closePicture();			}		});	},	drawingWorkPlanCardList : function (insertDivId,workPlanList){		function getCutName(name,cutLength){			return isNotNull(name) ? (name.length > cutLength ? name.substring(0,cutLength)+'...' : name) : '暂无';		}		var baseHtml = new Array();		baseHtml.push('<div class="mapMonitorBoxBorder-unselect" {clickEvent}>');		baseHtml.push('<div class="mapMonitorBox-edit">');		baseHtml.push('	<div class="{mapMonitorBoxTitle}" title="{planName}">');		baseHtml.push('	  <div class="mapMonitorBoxTitleNo"><img src="'+ctx+'/img/status-{colorValue}.png" width="50" height="50" /></div>');		baseHtml.push('	  <div class="mapMonitorBoxTitleText">{planCutName}</div>');		baseHtml.push('	</div>');		baseHtml.push('	<div class="mapMonitorBoxContent">');		baseHtml.push('	  <div class="mapMonitorBoxContentText"><img src="'+ctx+'/img/time-{colorValue}.png" width="20" height="20" />&nbsp;{planTime}</div>');		baseHtml.push('	  <div class="mapMonitorBoxContentSquare" title="{driverName}"><div class="user-logo-{colorValue}"></div><div style="width: 100%;">{driverCutName}</div></div>');		baseHtml.push('	  <div class="mapMonitorBoxContentSquare"><div class="count-logo-{colorValue}"></div><div style="width: 100%;">{planMilage}km</div></div>');		baseHtml.push('	  <div class="mapMonitorBoxContentSquare"><div class="fuel-logo-{colorValue}"></div><div style="width: 100%;">{planTotalFuel}</div></div>');		baseHtml.push('	</div>');		baseHtml.push('</div>');		baseHtml.push('</div>');		baseHtml = baseHtml.join('');		var clickEventHtml = 'onclick="vehicleMapMonitoringIndexControl.handlerVehiclePlanTrip(\'{planId}\',\'{planName}\',\'{planStartTime}\',\'{planEndTime}\');" style="cursor: pointer;" id="workPlanCard_{planId}"';		var insertHtml = new Array();		for(var i=0; i < workPlanList.length; i++){			var workPlan = workPlanList[i];			//alert(jsonToString(workPlan));return;			var driverName = workPlan.driverName,				driverCutName = getCutName(driverName,5),				planName = workPlan.planName,				planCutName = getCutName(planName,8),				state = workPlan.state,				planStartTime = workPlan.planStartTime,				planEndTime = workPlan.planEndTime,				mapMonitorBoxTitle = null,				colorValue = null,				clickEvent = null,				planTime = new Array();			if(state == '0'){				mapMonitorBoxTitle = 'mapMonitorBoxTitle4';				colorValue = 'h';				clickEvent = 'style="cursor: default;"';			}else if(state == '1'){				mapMonitorBoxTitle = 'mapMonitorBoxTitle5';				colorValue = 'y';				clickEvent = 'style="cursor: default;"';			}else if(state == '2'){				mapMonitorBoxTitle = 'mapMonitorBoxTitle';				colorValue = 'g';				clickEvent = clickEventHtml.format({					planId : workPlan.planId,					planStartTime : planStartTime,					planEndTime : planEndTime,					planName : workPlan.planName				});			}			if(isNotNull(planStartTime)){				planTime.push(dateFormat(planStartTime,'MM/dd hh:mm'));				if(isNotNull(planEndTime)){					planTime.push("~" + dateFormat(planEndTime,'MM/dd hh:mm'));				}			}else{				planTime.push('暂无');			}			planTime = planTime.join('');			var formatJSON = {				planName : handlerUndefined(workPlan.planName),				planCutName : planCutName,				driverName : handlerUndefined(driverName),				driverCutName : driverCutName,				planMilage : handlerUndefined(workPlan.distance),				planTotalFuel : handlerUndefined(workPlan.fuelConsumTotal)+"L",				mapMonitorBoxTitle : mapMonitorBoxTitle,				colorValue : colorValue,				clickEvent : clickEvent,				planTime : planTime			};			//alert(baseHtml.format(formatJSON));return;			insertHtml.push(baseHtml.format(formatJSON));		}		$("#" + insertDivId).html(insertHtml.join(''));		$("#" + insertDivId + " .mapMonitorBoxBorder-unselect").click(function() {			if(this.onclick){				$("#workPlanTableParentDiv .mapMonitorBoxBorder-unselect").removeClass("mapMonitorBoxBorder-select");				$(this).addClass("mapMonitorBoxBorder-select");			}		})		if(isNotNull(window.planId)){			var planCard = $("#workPlanCard_"+planId);			if(planCard){				planCard.trigger("click");				window.planId = null;			}		}	},	refreshNowTimeInfo : function(data,nowTimeWorkPlanDataList){		$('.nav-tabs li').eq(2).addClass("active").siblings().removeClass('active');		$(".tab-content .tab-pane").eq(2).addClass("active").siblings().removeClass('active');		if(typeof data != 'undefined'){			 $("#nowTimeInfoDiv").find('[data-name]').each(function(){				 var that = $(this);				 var key = that.attr('data-name');				 var value = data[key];				 value = isNotNull(value) ? value : '暂无';				 var prefix = that.attr('data-prefix');				 prefix = prefix == undefined ? '' : prefix;				 that.html(prefix + value);			 });		}		this.drawingWorkPlanCardList('workPlanTableParentDiv',nowTimeWorkPlanDataList);	},	_showTripTimeBar : function(){		function handlerUndefined(value){			return (value == undefined || (!isNotNull(value)) ? '暂无' : value);		}		var allSecondOfDay = 24 * 60 * 60,			timeBarHtml = new Array(),			tripParagraphArr = vehicleMapMonitoringIndexMapModule.getTripParagraphArr(),			trajectoryAlarmPointArr = vehicleMapMonitoringIndexMapModule.getTrajectoryAlarmPointArr();		//生成时间轴DIV		var baseHtml = '<div class="progress {cls}" style="width: {width}%; float: left" title="{title}" beginDate="{beginDate}" endDate="{endDate}" accState="{accState}" arrIndex="{index}"><div class="bar" style="width: 100%;"></div></div>',			alarmHtml = '<a data-content="{content}" class="alarm alarm-{alarmType}" data-title="{title}" style="left: {left}%;" data-lng="{lng}" data-lat={lat}></a>',			widthRatioCount = 0;		for(var i=0 ; i < tripParagraphArr.length; i++){			var tripParagraphPoints = tripParagraphArr[i];			var fristPoint = tripParagraphPoints[0];			var lastPoint = tripParagraphPoints[tripParagraphPoints.length-1];			var widthRatio = 0;			if(i == (tripParagraphArr.length - 1)){				widthRatio = 100 - widthRatioCount;//				lastPoint.obdDate = dateFormat(lastPoint.obdDate,'yyyy-MM-dd') + ' 23:59:59';			}else{//				if(i == 0){//					fristPoint.obdDate = dateFormat(fristPoint.obdDate,'yyyy-MM-dd') + ' 00:00:00';//				}				var secondDifference = daysBetween(fristPoint.obdDate,lastPoint.obdDate,'ss');				widthRatio = (secondDifference / allSecondOfDay).toFixed(8) * 100;				widthRatioCount += widthRatio;			}			timeBarHtml.push(baseHtml.format({				width : widthRatio,				accState : (fristPoint.accStatus == 0) ? 'off' : 'on',				index : i,				beginDate: fristPoint.obdDate,				endDate: lastPoint.obdDate,				cls : (fristPoint.accStatus == 0) ? 'progress-info' : 'progress-warning',				title : dateFormat(fristPoint.obdDate,'hh:mm:ss') + '~' + dateFormat(lastPoint.obdDate,'hh:mm:ss')			}));		}		for(var i=0 ; i < trajectoryAlarmPointArr.length; i++){			var trajectoryAlarmPoint = trajectoryAlarmPointArr[i],				alarmDate = trajectoryAlarmPoint.alarmTime,				alarmDateHour = dateFormat(alarmDate,'h'),				alarmDateMinute = dateFormat(alarmDate,'m');				alarmDateSecond = dateFormat(alarmDate,'s');				var alarmType = trajectoryAlarmPoint.alarmTypeCode;				switch(alarmType){					case '1004002':						alarmType = 'cx';						break;					case '1004003':						alarmType = 'dx';						break;					case '1004001':						alarmType = 'jd';						break;					case '9002':						alarmType = 'jj';						break;					case '9001':						alarmType = 'jx';						break;					case '9003':						alarmType = 'jz';						break;					case '9004':						alarmType = 'pl';						break;					case '269':						alarmType = 'kd';						break;				}				if(isNotNull(alarmDateHour) && isNotNull(alarmDateMinute)){					var alarmDateOfSecond = (parseInt(alarmDateHour) * 60 * 60) + (parseInt(alarmDateMinute) * 60) + parseInt(alarmDateSecond);					var leftRatio = (alarmDateOfSecond / allSecondOfDay).toFixed(8) * 100;					var content = '';					if(isNotNull(trajectoryAlarmPoint.driverName)){						content += trajectoryAlarmPoint.driverName;					}					if(isNotNull(trajectoryAlarmPoint.driverCode)){						content += trajectoryAlarmPoint.driverCode;					}					timeBarHtml.push(alarmHtml.format({						content : content + '在' + alarmDate + '发生'+ handlerUndefined(trajectoryAlarmPoint.alarmTypeName)+'告警',						title : handlerUndefined(trajectoryAlarmPoint.alarmTypeName),						left : leftRatio,						alarmType : alarmType,						lng : trajectoryAlarmPoint.lng,						lat : trajectoryAlarmPoint.lat					}));				}		}		if(timeBarHtml.length == 0){			var beginDate = todayDate + '00:00:00';			var endDate = todayDate + '23:59:59';			timeBarHtml.push(baseHtml.format({				width : 100,				accState : 'off',				index : 0,				beginDate: beginDate,				endDate: endDate,				cls : 'progress-info',				title : '00:00:00~23:59:59' 			}));		}		$("#timeBar").html(timeBarHtml.join(''));		$('#mapParent').css('height',(clientHeight - 231) + "px");		$('#playDiv').show();		$('#playDiv').animate( {'top' : (clientHeight - 196)}, 'slow');		$("#timeBarParentDiv").removeClass('display');		$("#clickTrajectorySectionDiv").addClass('display');		$("#planTripDiv").addClass('display');		$(".trackStartBtn").removeClass('display');		$(".trackPauseBtn").addClass('display');		$(".trackStopBtn").removeClass('display');		$(".returnAllTrajectory").addClass('display');		$("#timeBar .alarm").each(function(){			var a = $(this);			a.popover({				placement : 'top',				html : a.attr('data-title'),				trigger : 'hover',				content : a.attr('data-content')			});		});		$("#timeBar > .progress-info").unbind('mousemove');		$("#timeBar > .progress").click(function(){			if($(this).attr('accState') == 'on'){//				showPicture();				vehicleMapMonitoringIndexControl._refreshTrackInfoDivInfo(vehicleId,deviceCode,$(this).attr("beginDate"),$(this).attr("endDate"));				vehicleMapMonitoringIndexMapModule.clearOverlays();				vehicleMapMonitoringIndexControl.trajectoryRunning = vehicleMapMonitoringIndexMapModule.drawingDrivingTrajectoryParagraph($(this).attr('arrIndex'));//				closePicture();				$(".returnAllTrajectory").removeClass('display');//removeParagraphInfo				$(".trackStartBtn").removeClass('display');				$(".trackStopBtn").removeClass('display');				$(".trackPauseBtn").addClass('display');				$("#timeBarParentDiv").addClass('display');				$("#clickTrajectorySectionDiv").removeClass('display');				$("#planTripDiv").addClass('display');				$('#mapParent').css('height',(clientHeight - 172) + "px");				$('#playDiv').show();				$('#playDiv').animate( {'top' : (clientHeight - 136)}, 'slow');				$('#trajectorySectionTimes').html($(this).attr("title"));			};		});	},	_initTimeBarBtn : function(){		$(".returnAllTrajectory").click(function(){//			showPicture();			vehicleMapMonitoringIndexControl._refreshTrackInfoDivInfo(vehicleId,deviceCode,todayDate+' 00:00:00',todayDate+' 23:59:59');			vehicleMapMonitoringIndexMapModule.clearOverlays();			vehicleMapMonitoringIndexControl.trajectoryRunning = vehicleMapMonitoringIndexMapModule.drawingAllDrivingTrajectory();			clearTimeout(vehicleMapMonitoringIndexControl.timer);//			closePicture();			$('#mapParent').css('height',(clientHeight - 231) + "px");			$('#playDiv').animate( {'top' : (clientHeight - 196)}, 'slow');			$(".returnAllTrajectory").addClass('display');			$(".trackStartBtn").removeClass('display');			$(".trackPauseBtn").addClass('display');			$(".trackStopBtn").removeClass('display');			$("#clickTrajectorySectionDiv").addClass('display');			$("#timeBarParentDiv").removeClass('display');			$("#planTripDiv").addClass('display');			$("#workPlanTableParentDiv .mapMonitorBoxBorder-unselect").removeClass("mapMonitorBoxBorder-select");			$(".trackStartBtn").removeClass('display');			$(".trackPauseBtn").addClass('display');		});		$(".trackStopBtn").click(function(){			clearTimeout(vehicleMapMonitoringIndexControl.timer);			vehicleMapMonitoringIndexControl.trajectoryRunning.reset();			$(".trackStartBtn").removeClass('display');			$(".trackPauseBtn").addClass('display');			$("#lineColorControl").css('display','inline');		});		$(".trackStartBtn").click(function(){			$(".trackPauseBtn").removeClass('display');			$(".trackStartBtn").addClass('display');			$("#lineColorControl").css('display','none');			$('#lineColorControlDiv').animate( {'top' : -225}, 'slow');			vehicleMapMonitoringIndexControl._timerHandler();			//setTimeout(vehicleMapMonitoringIndexControl.trajectoryRunning.gotoNextPoint(),500);		});		$(".trackPauseBtn").click(function(){			clearTimeout(vehicleMapMonitoringIndexControl.timer);			$(".trackStartBtn").removeClass('display');			$(".trackPauseBtn").addClass('display');		});	},	_timerHandler : function(){		var isLast = vehicleMapMonitoringIndexControl.trajectoryRunning.gotoNextPoint();		if(isLast){			clearTimeout(vehicleMapMonitoringIndexControl.timer);			vehicleMapMonitoringIndexControl.trajectoryRunning.resetIndex(0);			$(".trackStartBtn").removeClass('display');			$(".trackPauseBtn").addClass('display');			$("#lineColorControl").css('display','inline');		}else{			vehicleMapMonitoringIndexControl.timer = setTimeout(vehicleMapMonitoringIndexControl._timerHandler,300);		}	},	_initLiClick : function(){		$('.nav-tabs li').click(function(){			var index = $(this).index();			if(index == 0 && vehicleMapMonitoringIndexControl.isSearched){				clearTimeout(vehicleMapMonitoringIndexControl.timer);				$("#notTimeDateLi").addClass('display');				$("#historyDateLi").addClass('display');				var treeObj = $.fn.zTree.getZTreeObj("deptAdnVehcileTree");				var selectNodes = treeObj.getSelectedNodes();				if(selectNodes.length > 0){					var node = selectNodes[0];					eval(node.click);					$("#searchTableDiv .mapMonitorBoxBorder-unselect").removeClass("mapMonitorBoxBorder-select");				}			}else if(index == 2 && !$(this).hasClass('active')){				vehicleMapMonitoringIndexControl.showVehicleDrivingTrajectory(vehicleId,deviceCode);			}else if(index == 3 && !$(this).hasClass('active')){				var historyDateSplitArr = historyDate.split('-');				window.frames[0].window.day_Click(parseInt(historyDateSplitArr[0]),parseInt(historyDateSplitArr[1]),parseInt(historyDateSplitArr[2]));			}		});	},	_refreshTrackInfoDivInfo : function(vehicleId,deviceCode,beginDate,endDate){		//alert(vehicleId +','+ beginDate +',' + endDate);		alert(865);		$.ajax({				url : ctx + '/monitoringModule/vehicleMapMonitoring/getVehicleDrivingTrajectoryInfo.do',				type : 'POST',				data : {vehicleId : vehicleId,				 deviceCode : deviceCode,				 beginDate : beginDate,				 endDate : endDate				},				dataType : 'JSON', 				cache : false,//				async : false,				beforeSend : function(){					showPicture();				},//				complete : function(){//					//				},				success : function(data){					if(data.states == 200){						function handlerHtml(label,value){							var baseHtml = '<label class="span6" style="text-align: right;">{label}：</label><label class="span6" style="text-align: left;">{value}</label>';							return baseHtml.format({								label : label,								value : value							});						}						var info = data.nowTimeStatisticsDataVO;						info = info == undefined ? {} : info;						var runTotalTime = info.runTotalTime;						var totalDistance = info.totalDistance;						if(runTotalTime != undefined && totalDistance != undefined){							info['avgSpeed'] = Math.round(totalDistance / (runTotalTime / 3600).toFixed(4));						}						var threeFast = 0,							accelerateTimes = info.accelerateTimes,							decelerateTimes = info.decelerateTimes,							sharpTurnTimes = info.sharpTurnTimes;						if(accelerateTimes != undefined && accelerateTimes > 0)threeFast += accelerateTimes;						if(decelerateTimes != undefined && decelerateTimes > 0)threeFast += decelerateTimes;						if(sharpTurnTimes != undefined && sharpTurnTimes > 0)threeFast += sharpTurnTimes;						info['threeFast'] = threeFast == 0 ? '暂无' :  threeFast;						 $(".divchild-c").find('[data-name]').each(function(){							 var that = $(this);							 var key = that.attr('data-name');							 var value = info[key];							 value = isNotNull(value) ? value : '暂无';							 if((key == 'idingDuration' || key == 'runTotalTime') && value > 0){								value = secondFormat(value, 'hh:mm') + '(时)';							 }							 var prefix = that.attr('data-prefix');							 value += isNotNull(prefix) ? prefix : '';							 var suffix = that.attr('data-suffix');							 value += (value != '暂无' && isNotNull(suffix))? suffix : '';							 that.html(value);						 });					}else{						alertMessage("查询轨迹统计信息出错，请联系管理员！",0);					}					closePicture();				}		});			},	handlerVehiclePlanTrip : function(planId,planName,startDate,endDate){		//this._refreshTrackInfoDivInfo(vehicleId,deviceCode,startDate,endDate);//		showPicture();		function getCutName(name,cutLength){			return isNotNull(name) ? (name.length > cutLength ? name.substring(0,cutLength)+'...' : name) : '暂无';		}		clearTimeout(vehicleMapMonitoringIndexControl.timer);		function getPlatnTripInfo(){			$.ajax({				url : ctx + '/monitoringModule/vehicleMapMonitoring/getVehiclePlatnTripInfo.do',				type : 'POST',				data : {planId : planId},				dataType : 'JSON', 				cache : false,//				async : false,				beforeSend : function(){					showPicture();				},//				complete : function(){//					//				},				success : function(data){					if(data.states == 200){						function handlerHtml(label,value){							var baseHtml = '<label class="span6" style="text-align: right;">{label}：</label><label class="span6" style="text-align: left;">{value}</label>';							return baseHtml.format({								label : label,								value : value							});						}						var info = data.nowTimeStatisticsDataVO;						info = info == undefined ? {} : info;						var threeFast = 0,							accelerateTimes = info.accelerateTimes,							decelerateTimes = info.decelerateTimes,							sharpTurnTimes = info.sharpTurnTimes;						if(accelerateTimes != undefined && accelerateTimes > 0)threeFast += accelerateTimes;						if(decelerateTimes != undefined && decelerateTimes > 0)threeFast += decelerateTimes;						if(sharpTurnTimes != undefined && sharpTurnTimes > 0)threeFast += sharpTurnTimes;						info['threeFast'] = threeFast == 0 ? '暂无' :  threeFast;						 $(".divchild-c").find('[data-name]').each(function(){							 var that = $(this);							 var key = that.attr('data-name');							 var value = info[key];							 value = isNotNull(value) ? value : '暂无';							 if((key == 'idingDuration' || key == 'runTotalTime') && value > 0){								value = secondFormat(value, 'hh:mm') + '(时)';							 }							 var prefix = that.attr('data-prefix');							 value += isNotNull(prefix) ? prefix : '';							 var suffix = that.attr('data-suffix');							 value += (value != '暂无' && isNotNull(suffix))? suffix : '';							 that.html(value);						 });					}else{						alertMessage("查询轨迹统计信息出错，请联系管理员！",0);					}				}			});				}		getPlatnTripInfo();		vehicleMapMonitoringIndexMapModule.clearOverlays();		vehicleMapMonitoringIndexControl.trajectoryRunning = vehicleMapMonitoringIndexMapModule.drawingDrivingTrajectoryByTime(startDate,endDate);		closePicture();		$("#timeBarParentDiv").addClass('display');		$("#clickTrajectorySectionDiv").addClass('display');		$("#planTripDiv").removeClass('display');		var planCutName = getCutName(planName,10);		$("#planTripDiv_planName").html(planCutName);		$("#planTripDiv_planName").attr("title",planName);		$("#planTripDiv_planTime").html(dateFormat(startDate,'MM/dd hh:mm')+'~'+dateFormat(endDate,'MM/dd hh:mm'));		$(".trackPauseBtn").addClass('display');		$(".trackStartBtn").removeClass('display');		$(".trackStopBtn").removeClass('display');		$(".returnAllTrajectory").removeClass('display');		$('#mapParent').css('height',(document.body.clientHeight - 175) + "px");		$('#playDiv').show();		$('#playDiv').animate( {'top' : (clientHeight - 138)}, 'slow');	}} function getVehicleStateVal(state){	switch(state){		case '1':			return '正常';		case '2':			return '停运';		case '3':			return '作废';		case '4':			return '故障';		case '5':			return '空闲';		case '6':			return '出勤';		default:			return '暂无';	}}