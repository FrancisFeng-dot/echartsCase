$(function(){ 	$("#deptId").val(parDeptId);//初始化当前机构ID	var query_dept = {			deptId : parDeptId,			fieldtext : "deptName",			fieldValue : "deptId"	} ;			$("#temp_urls").val(urls);	$("#temp_nowSelectId").val("select");	//下拉框ID、条件、div的ID、用来输出选中的下拉框值、回调方法	var sl = $.initSelect.initFirstSelect('select', query_dept,'SelectBox1', 'deptId',callback);		//机构概况 信息	findDeptDetail();	//利用率中点火时长排名加载	drivingRank('tab1_content','dept');		//加载点火时长趋势图	loadDriverTime();		//加载  总点火时长门占比图 饼状图	loadDriverTimeDept();		//地图热点	getMap();		//初始化底部列表分页	var grid = $.grid.init('grid_utilization', 'utilizationAnalysisService', orgGridRenderer);	//绑定底部列表切换事件	$("#utilizationList").click(function(){			query();	});		//详细数据点击事件	$("#moreDetail").click(function(){		var deptId = $("#deptId").val(); 		var queryDay = $("#queryDay").val();		var findType = $("#findType").val();				var url = $(this).attr("rel_url")+"?deptId="+deptId+"&queryDay="+queryDay+"&findType="+findType;		//window.location.href = url;		openTab('点熄火统计',url);		});		//效率类型选择器	jQuery(".efficiencyType").find(".radio").bind("click", function () {		$(this).addClass("acur").siblings().removeClass("acur");		var radio_val = $("input[name='tab'][type='radio']:checked").val();		$("#efficiencyType").val(radio_val);		getMap();		//地图热点		getMapJson(null,null,2);	});}); //选中机构下拉宽后  回调方法function callback(data,selValue){	//判断是否为底层机构	if((data == null || data.length == 0) && selValue != '-1' ){		//底层机构则跳转至详情页面		var url = $("#query_utilization").attr("last_url");		window.location.href=url+"?deptId="+$("#deptId").val()+"&queryDay="+$("#queryDay").val()+"&efficiencyType="+$("#efficiencyType").val();	}else{ 		//地图热点		getMapJson(null,null,2);//地图热点	}}//初始化 chart数据 var container2 = null;var container3 = null;//暂存比例图数据var container2Categories = null;var container3Categories = null;//暂存分析图数据var container2Data = null;var container3Data = null;//---------------------------点火时长趋势图 START-------------------------------------------//加载点火时长趋势图function loadDriverTime(){	var efficiencyType  =  $("#efficiencyType").val();	var queryDay = $("#queryDay").val();	var deptId = $("#deptId").val();	var textName = "" ;	var yAxisName = "";		if(efficiencyType == "driveTime"){		textName = "点火时长趋势图";		yAxisName = "h";		document.getElementById('tendencyChartName').innerHTML = "点火时长趋势图";	}else if (efficiencyType == "lazyTime"){		textName = "怠速时长趋势图";		yAxisName = "分";		document.getElementById('tendencyChartName').innerHTML =  "怠速时长趋势图" ;	}else {		textName = "行驶里程趋势图";		yAxisName = "km";		document.getElementById('tendencyChartName').innerHTML =  "行驶里程趋势图" ;	}	//初始化 点火时长趋势图	$('#container2').highcharts({			chart : {				type : 'line'			},			title : {				text : textName,				y:6			},			xAxis : {				categories : [],				labels : {					rotation : -45,					align : 'right',					style : {						fontSize : '12px',						fontFamily : 'Verdana, sans-serif'					}				}			},			yAxis : {				min:0, // 定义最小值  				title : {					text : yAxisName				}			},			tooltip : {				valueSuffix : yAxisName			},			series : []	});	container2 = $('#container2').highcharts();	//加载图表数据	$.ajax({		"type" : 'post',		"url" : ctx+ '/topicAnalysis/utilizationAnalysis/driverTime.do',		"dataType" : "json",		"data" : {			deptId : deptId,			queryDay : queryDay,			efficiencyType : efficiencyType		},		"success" : function(resp) {			container2Categories = resp["container2"]["categories"];			container2Data = resp["container2"]["data"];			createChart("driverTime",textName);					}	});}//---------------------------点火时长趋势图  END-------------------------------------------//---------------------------  总点火时长机构占比图  STAST-------------------------------------------// 总点火时长机构占比图function loadDriverTimeDept(){		var efficiencyType  =  $("#efficiencyType").val();	var queryDay = $("#queryDay").val();	var deptId = $("#deptId").val();	var textName = "" ;		if(efficiencyType == "driveTime"){		textName = "总点火时长机构占比";		document.getElementById('pieGraphName').innerHTML = "总点火时长机构占比";	}else if (efficiencyType == "lazyTime"){		textName = "总怠速时长机构占比";		document.getElementById('pieGraphName').innerHTML =  "总怠速时长机构占比" ;	}else {		textName = "总行驶里程机构占比";		document.getElementById('pieGraphName').innerHTML =  "总行驶里程机构占比" ;	}		//初始化 总点火时长机构占比图	$('#container3').highcharts({		chart : {			plotBackgroundColor : null,			plotBorderWidth : null,			plotShadow : false		},		title : {			text : '',			y:6		},		tooltip : {			pointFormat : '{series.name}: <b>{point.percentage:.1f}%</b>'		},		plotOptions : {			pie : {				allowPointSelect : true,				cursor : 'pointer',				dataLabels : {					enabled : true,					color : '#000000',					connectorColor : '#000000',					format : '<b>{point.name}</b>: {point.percentage:.1f} %'				}			}		},		series : [ {			type : 'pie',			name : '所占比例',			data : []		} ]	});	container3 = $('#container3').highcharts();	//加载图表数据	$.ajax({		"type" : 'post',		"url" : ctx+ '/topicAnalysis/utilizationAnalysis/driverTimeDept.do',		"dataType" : "json",		"data" : {			deptId : deptId,			queryDay : queryDay,			efficiencyType : efficiencyType		},		"success" : function(resp) {						var objArr = eval(resp.pie);//joson对象转数组			container3Data = null;			for(var i=1;i<objArr.length;i++){				if(objArr[i][1]>0){					container3Data = resp["pie"];					break;					}			}						//container3Data = resp["pie"];			createChart("driverTimeDept",textName);		}	});}//---------------------------  总点火时长机构占比图 END-------------------------------------------//构造图表function createChart(tabName,textName) {		if("driverTime" == tabName){				if (typeof (container2Data) != "undefined") {			container2.setTitle( {text: textName });			//更新趋势图数据			var feeTendencySeries = eval(container2Data);			if(container2 != null){				clearChart(container2);			}			if(feeTendencySeries != 'undefined' && feeTendencySeries != null && feeTendencySeries != ''){				$.each(feeTendencySeries, function(n, value) {					container2.addSeries(value, false);				});			}						container2.xAxis[0].setCategories(eval(container2Categories),true);		}else{			container2.setTitle( {text: '暂无数据' });		}			}else if("driverTimeDept" == tabName){				if (container3Data == null){			container3.setTitle( {text: '暂无数据' });		}else if( container3Data.length > 2 ) {			container3.setTitle( {text: textName });			var feePiedata = eval(container3Data);			//更新饼图数据			container3.series[0].update({				data : feePiedata			});		}else{			container3.setTitle( {text: '暂无数据' });		}	}	}//----------------------------------------------------------------//----------------------------地图热点图 start------------------------------------------------//定义地图var BMapExt;var myChart;function getMap(){		require.config({    paths: {        echarts: '../../js/map/doc/example/www/js'    },    packages: [        {            name: 'BMap',            location: '../../js/map/extension/BMap/src',            main: 'main'        }    ]});require([    'echarts',    'BMap',    'echarts/chart/map'],function (echarts, BMapExtension) {    $('#main').css({        height:$('#main').parent().height(),        width: $('#main').parent().width()    });      var url = $("#mapFrom").attr("action");  var queryDay = $("#queryDay").val();  var efficiencyType = $("#efficiencyType").val();	var deptId = parDeptId;    $.ajax({        type: "POST",        url: url,        data: {deptId:deptId,queryDay:queryDay,efficiencyType:efficiencyType},        dataType: "json",        success: function(data){        	// 初始化地图        	BMapExt = new BMapExtension($('#main')[0], BMap, echarts,{        	    enableMapClick: false        	});        	var map = BMapExt.getMap();        	var container = BMapExt.getEchartsContainer();        	var locations = [];        	$.each(data.son,function(key,values){        		locations.push(values);    		});    		var point = new BMap.Point(locations[0][0], locations[0][1]);        	map.centerAndZoom(point, 8);        	map.enableScrollWheelZoom(true);          // 创建一个DOM元素      	  var divText = document.createElement("div");          // 添加文字说明      	 if(efficiencyType == 'driveTime'){      		divText.appendChild(document.createTextNode('点火时长热点分布'));         }else if(efficiencyType == 'lazyTime'){        	 divText.appendChild(document.createTextNode('怠速时长热点分布'));         }else{        	 divText.appendChild(document.createTextNode('行驶里程热点分布'));         }         // divText.appendChild(document.createTextNode("点火时长热点分布"));          // 设置样式          divText.style.cursor = "pointer";          divText.style.border = "1px solid gray";          divText.style.backgroundColor = "white";          divText.style.position = "absolute";          divText.style.right = "5px";          divText.style.top = "5px";          divText.style.fontSize="15px";          divText.style.padding="3px";          map.getContainer().appendChild(divText);        	// 地图自定义样式        	option = {        	    color: ['gold','aqua','lime'],        	    title : {        	        text: '',        	        subtext:'',        	        x:'right'        	    },        	    tooltip : {        	        trigger: 'item',        	        formatter: function (v) {        	            if(typeof (v[1]) != 'undefined'){        	            	return v[1]+v[2]+data.unit;          	        	}else{          	        		return null;          	        	}        	        }        	    },                	    toolbox: {        	        show : false        	    },        	    dataRange: {        	        min : 0,        	        max : data.max,        	        y: '60%',        	        calculable : true,        	        color: ['#ff3333', 'orange', 'yellow','lime','aqua']        	    },        	    series : [        	        {        	            name:'子集',        	            type:'map',        	            mapType: 'none',        	            data:[],                    	            geoCoord: data.son,        				markLine : {        	                smooth:true,        	                effect : {        	                    show: true,        	                    scaleSize: 1,        	                    period: 30,        	                    color: '#fff',        	                    shadowBlur: 10        	                },        	                itemStyle : {        	                    normal: {        	                        borderWidth:1,        	                        lineStyle: {        	                            type: 'solid',        	                            shadowBlur: 10        	                        }        	                    }        	                },        	                data : [        	                ]        	            },        	            markPoint : {        	                symbol:'emptyCircle',        	                symbolSize : function (v){        	                    return 10 + v/10        	                },        	                effect : {        	                    show: true,        	                    shadowBlur : 0        	                },        	                itemStyle:{        	                    normal:{        	                        label:{show:false}        	                    }        	                },        	                data : data.num        	            }        	                    	        }        	    ]        	};        	if (myChart&& myChart.dispose) {        	    myChart.dispose();        	}        	myChart = BMapExt.initECharts(container);        	//绑定点击事件        	var ecConfig = require('echarts/config');        	function eConsole(param) {        		//var str = param.name + ":" + param.value;        		getMapJson(null,param.name);        	}        	myChart.on(ecConfig.EVENT.CLICK, eConsole);        	window.onresize = myChart.resize;        	BMapExt.setOption(option, true);        }    });});}//获取MapJson数据function getMapJson(deptId,deptName,sel){	if(!deptId){		deptId = $("#deptId").val();	}	var url = $("#mapFrom").attr("action");    var queryDay = $("#queryDay").val();    //类型    var efficiencyType = $("#efficiencyType").val();    if(!sel){		sel = 1;	}        $("#temp_nowSelectId").val(this.nowSelectId);	$("#temp_urls").val(this.urls);	$.ajax({    type: "POST",    url: url,    data: {deptId:deptId,queryDay:queryDay,efficiencyType:efficiencyType,deptName:deptName},    dataType: "json",    success: function(data){    	if(data.error){    		//错误情况：被选择机构下无下属机构或车辆    		alertMessage(data.error);    	}else{    		//修改机构ID值        	if(data.deptId){        		$("#deptId").val(data.deptId);        	}        	        	//判断是否为底层机构        	if(data.isLast){        		//底层机构则跳转至详情页面        		var url = $("#query_utilization").attr("last_url");        		window.location.href=url+"?deptId="+data.deptId+"&queryDay="+$("#queryDay").val()+"&efficiencyType="+$("#efficiencyType").val();        		        	}else{        		var a_ption = myChart.getOption();    			        		var  seriesList = a_ption.series;        		        		var  dataRange = a_ption.dataRange;        		        		seriesList[0].geoCoord = data.son;        		        		seriesList[0].markPoint.data = data.num;        		        		dataRange.max = data.max;        				        		a_ption.series = seriesList;        		        		a_ption.dataRange = dataRange;        		        		BMapExt.setOption(a_ption, true);        		        		var map = BMapExt.getMap();          		var locations = [];        		$.each(data.son,function(key,values){        			locations.push(values);        		});        		var point = new BMap.Point(locations[0][0], locations[0][1]);            	map.centerAndZoom(point, 8);        		 		        		findDeptDetail();//机构概况 信息         		//地图右边  利用率中点火时长排名加载         		var findType = $("#findType").val();        		drivingRank('tab1_content',findType);        		        		query();//底部  - 列表展示        		        		//底部列表        		if($("#behaviorList").parent().attr("class")=='active'){        			$("#behaviorList").click();        		}else{        			//以下是调用触所有要联动的表图        			loadDriverTime();//加载点火时长趋势图            		loadDriverTimeDept();//加载  总点火时长门占比图 饼状图        		}	                		if(1 == sel){        			var nowSelectId = $("#temp_nowSelectId").val();            		var urls = $("#temp_urls").val();            		jsSelectItemByValue(nowSelectId,data.deptId);                     		var query_dept = {            				deptId : data.deptId,            				fieldtext : "deptName",            				fieldValue : "deptId"            			} ;            		$.initSelect.ajaxNextSelect(urls, nowSelectId ,data.deptId, query_dept, 'SelectBox1',0);        		}        	}    	    	}    	    }});}//----------------------------地图热点图 end--------------------------------------------------//----------------------------底部列表查询方法 start-------------------------------------------------function query(pageStart,deptId,isLast) {		//如果为底层机构则跳转至底层机构详情页面	if(isLast&&isLast==1){		var url = $("#query_utilization").attr("last_url");		window.location.href=url+"?deptId="+deptId+"&queryDay="+$("#queryDay").val()+"&efficiencyType="+$("#efficiencyType").val();	}else{		var query = serializeArrayByForm('query_behavior');		if(isNotNull(pageStart)){			query['new_page_start'] = pageStart;		}		if(isNotNull(deptId) && deptId != 'root'){			query['deptId'] = deptId;		}else{			query['deptId'] = $("#deptId").val();		}		var queryDay = $("#queryDay").val();		query['queryDay'] = queryDay;		$('#grid_utilization').trigger('grid.query', [ query ]);		//自动排序		//$("#grid_behavior").tablesorter(); 	}	}	function orgGridRenderer(data, idx) {	var trCfg = {		tdList : [			{text : data.rowNo},			{text : '<a href="javascript:void(0)" onclick="getMapJson(null,'+"'"+data.deptName+"'"+');">'+data.deptName+'</a>'},			{text : data.vehicleNums},			{text : data.mileageTotal},			{text : data.driverTimeTotal},			{text : data.driverTimeDay},			{text : data.lazyDuration},			{text : data.lazyDurationDay},			{text : (data.lazyRate*100).toFixed(2)+'%'}		]	}; 	return trCfg;}//----------------------------底部列表展示 end---------------------------------------------------//excle表格导出function exportExcle(){	var deptId = $("#deptId").val();	var theads=$('#grid_utilization thead tr th');//获取所有的表头	var thead = "";	for ( var i = 0; i < theads.length; i++) {		thead = thead+$(theads[i]).html()+",";	}	var queryDay = $("#queryDay").val();	thead = encodeURI(thead);	thead = encodeURI(thead);	window.location.href=ctx+'/topicAnalysis/utilizationAnalysis/exportExcle.do?deptId='+deptId+'&thead='+thead+'&queryDay='+queryDay;}//日期查询选择器function selDate(num){		if(null == num || "" == num || 0 == num){		num = 7;	}	$("#queryDay").val(num);			//以下是调用触所有要联动的表图	getMapJson(null,null,2);//地图热点		//底部列表	if($("#utilizationList").parent().attr("class")=='active'){		$("#utilizationList").click();	}	}//--------------------------- 机构概况信息 start-------------------------------------------function findDeptDetail(){	var deptId = $("#deptId").val();	var queryDay = $("#queryDay").val();	$.ajax({		"type" : 'post',		"url" : ctx+ '/topicAnalysis/safetyAnalysis/findDeptDetail.do',		"dataType" : "json",		"data" : {			deptId : deptId,			num : queryDay		},		"success" : function(deptInfo) {			if (typeof (deptInfo) != "undefined") {				$("#VEHICLE_NUMS").html(deptInfo["VEHICLE_NUMS"]);				$("#DRIVER_NUMS").html(deptInfo["DRIVER_NUMS"]);				$("#FAULT_VEHICLE_NUMS").html(deptInfo["FAULT_VEHICLE_NUMS"]);				$("#MILEAGE_TOTAL").html(deptInfo["MILEAGE_TOTAL"]);				$("#DRIVER_TIME_TOTAL").html(deptInfo["DRIVER_TIME_TOTAL"]);			}		}	});}//--------------------------- 机构概况信息 END-------------------------------------------//---------------------------------驾驶行为排名 tab页切换 START----------------------------------------function drivingRank(divId,findType) {  	var efficiencyType = $("#efficiencyType").val();    $("#findType").val(findType);        if(efficiencyType == 'driveTime'){    	document.getElementById('efficiencyName').innerHTML = '点火时长排名';    }else if(efficiencyType == 'lazyTime'){    	document.getElementById('efficiencyName').innerHTML = '怠速时长排名';    }else{    	document.getElementById('efficiencyName').innerHTML = '行驶里程';    }        findFuelOrderDate(findType,divId,efficiencyType);    };//拿到利用率排序数据function findFuelOrderDate(findType,divId,efficiencyType){	var deptId = $("#deptId").val();	var queryDay = $("#queryDay").val();	$.ajax({		"type" : 'post',		"url" : ctx+ '/topicAnalysis/utilizationAnalysis/findDeptVehDriverTimeData.do',		"dataType" : "json",		"data" : {			deptId : deptId,			num : queryDay,			findType : findType,			efficiencyType : efficiencyType		},		"success" : function(deptInfo) {			$("#"+divId+" ul").remove();			$("#"+divId).append('<ul class="list" style="height:332px; padding:0 !important;"> </ul>');			if(findType == "vehicle"){				if(efficiencyType == 'driveTime'){					$("#"+divId+" ul").append('<li class="name" ><span class="w3 color1">排名</span><span class="w3 color1">车牌</span><span class="w3 color1">机构</span><span class="w3 color1">点火时长(h/日)</span></li>');					if(deptInfo==''){						$("#"+divId+" ul").append('<li style="text-align:center;"><span class="w8" style="float: none;">暂无数据</span></li>');					}			    }else if(efficiencyType == 'lazyTime'){			    	$("#"+divId+" ul").append('<li class="name" ><span class="w3 color1">排名</span><span class="w3 color1">车牌</span><span class="w3 color1">机构</span><span class="w3 color1">怠速时长(时/日)</span></li>');			    	if(deptInfo==''){						$("#"+divId+" ul").append('<li style="text-align:center;"><span class="w8" style="float: none;">暂无数据</span></li>');					}			    }else{			    	$("#"+divId+" ul").append('<li class="name" ><span class="w3 color1">排名</span><span class="w3 color1">车牌</span><span class="w3 color1">机构</span><span class="w3 color1">行驶里程(KM/日)</span></li>');			    	if(deptInfo==''){						$("#"+divId+" ul").append('<li style="text-align:center;"><span class="w8" style="float: none;">暂无数据</span></li>');					}			    }				if (typeof (deptInfo) != "undefined") {					for (var i = 0; i <= deptInfo.length - 1; i++) {						var str = "'"+deptInfo[i]["VEHICLE_ID"]+"'";						$("#"+divId+" ul").append('<li><span class="w3">'+(i+1)+'</span> <span class="w3"><a href="#" title="'+deptInfo[i]["VEHICLE_CODE"]+'" onClick="findCarTrajectory('+str+')">'+deptInfo[i]["VEHICLE_CODE"]+'</a> </span> <span  title="'+deptInfo[i]["DEPT_NAME"]+'" class="w3">'+deptInfo[i]["DEPT_NAME"]+'</span> <span class="w3">'								+deptInfo[i]["DRIVER_TIME"]+'</span></li>');					} 				}							}			if(findType == "dept"){				if(efficiencyType == 'driveTime'){					$("#"+divId+" ul").append('<li class="name"><span class="w1 color1">排名</span><span class="w1 color1">机构</span><span class="w1 color1">点火时长(时/车/日)</span>');					if(deptInfo==''){						$("#"+divId+" ul").append('<li style="text-align:center;"><span class="w8" style="float: none;">暂无数据</span></li>');					}			    }else if(efficiencyType == 'lazyTime'){			    	$("#"+divId+" ul").append('<li class="name"><span class="w1 color1">排名</span><span class="w1 color1">机构</span><span class="w1 color1">怠速时长(时/车/日)</span>');			    	if(deptInfo==''){						$("#"+divId+" ul").append('<li style="text-align:center;"><span class="w8" style="float: none;">暂无数据</span></li>');					}			    }else{			    	$("#"+divId+" ul").append('<li class="name"><span class="w1 color1">排名</span><span class="w1 color1">机构</span><span class="w1 color1">行驶里程(km/日)</span>');			    	if(deptInfo==''){						$("#"+divId+" ul").append('<li style="text-align:center;"><span class="w8" style="float: none;">暂无数据</span></li>');					}			    }												if (typeof (deptInfo) != "undefined") {					for (var i = 0; i <= deptInfo.length - 1; i++) {						var cs = "'"+findType+"'"+",'"+divId+"','"+deptInfo[i]["DEPT_ID"]+"'";						$("#"+divId+" ul").append('<li><span class="w1">'+(i+1)+'</span> <span class="w1"><a href="#" onClick="findDeptFuelOrderDate('+cs+')">'+deptInfo[i]["DEPT_NAME"]+'</a> </span> <span class="w1">'+deptInfo[i]["DEPTDRIVERTIME"]+'</span> ');					} 				}			}		}	});}//跳转至行车轨迹function findCarTrajectory(vehicelId){	var rel_url = ctx+ '/resourcesManage/drivingReport/index.do';	openTab('行车报告',rel_url+"?vehicleId="+vehicelId);}/** * 创建新标签 * @param name * @param url */function openTab(name,url){	window.parent.$.fn.jerichoTab.addTab({         tabFirer: null,         title: name,         closeable: true,         data: {             dataType: 'iframe',             dataLink: url         }     }).showLoader().loadData();     resizeTab();}//点击机构查询机构下利用率信息function findDeptFuelOrderDate(findType,divId,deptId){	$("#deptId").val(deptId);		if(findDeptDetailInfo() == 1 ){		//底层机构则跳转至详情页面		var url = $("#query_utilization").attr("last_url");		window.location.href=url+"?deptId="+$("#deptId").val()+"&queryDay="+$("#queryDay").val()+"&efficiencyType="+$("#efficiencyType").val();	}else{		//地图热点		getMapJson();	}}//拿到机构信息function findDeptDetailInfo(){	var deptId = $("#deptId").val(); 	var isLast ; 	$.ajax({		"type" : 'post',		"url" : ctx+ '/topicAnalysis/safetyAnalysis/findDeptInfo.do',		"dataType" : "json",		"async" : false,  		"data" : {			deptId : deptId		},		"success" : function(deptInfo) {			if (typeof (deptInfo) != "undefined") {				 isLast = deptInfo.isLast ;			}		}	});	return isLast;}//---------------------------------驾驶行为排名 tab页切换 END----------------------------------------