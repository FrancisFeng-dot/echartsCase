$(function(){ 	var deptId = $("#deptId").val();//初始化当前机构ID		//加载点火时长趋势图	loadDriverTime();	//机构概况 信息	findDeptDetail();	//运行时长排名加载	drivingRank('container21','vehicle','driveTime');	//怠速时长排名加载	drivingRank('container31','vehicle','lazyTime');		//行驶里程排名加载	drivingRank('container41','vehicle','mileage');	//怠速比率排名加载	drivingRank('container51','vehicle','lazyRatio');		//初始化底部列表分页	var grid = $.grid.init('grid_utilezation', 'vehicleUtilezationService', orgGridRenderer);	//绑定底部列表切换事件	$("#utilezationList").click(function(){			query();	});		//效率类型选择器	jQuery(".efficiencyType").find(".radio").bind("click", function () {		$(this).addClass("acur").siblings().removeClass("acur");		var radio_val = $("input[name='tab'][type='radio']:checked").val();		$("#efficiencyType").val(radio_val);		//加载点火时长趋势图		loadDriverTime();	});}); //初始化 chart数据 var container2 = null;//暂存比例图数据var container2Categories = null;//暂存分析图数据var container2Data = null;//--------------------------点火时长趋势图  START-------------------------------------------//点火时长趋势图function loadDriverTime(){	var efficiencyType  =  $("#efficiencyType").val();	var queryDay = $("#queryDay").val();	var deptId = $("#deptId").val();	var textName = "" ;	var yAxisName = "";		if(efficiencyType == "driveTime"){		textName = "点火时长趋势图";		yAxisName = "h";		document.getElementById('tendencyChartName').innerHTML = "点火时长趋势图";	}else if (efficiencyType == "lazyTime"){		textName = "怠速时长趋势图";		yAxisName = "分";		document.getElementById('tendencyChartName').innerHTML =  "怠速时长趋势图" ;	}else {		textName = "行驶里程趋势图";		yAxisName = "km";		document.getElementById('tendencyChartName').innerHTML =  "行驶里程趋势图" ;	}		//初始化 点火时长趋势图	$('#container2').highcharts({			chart : {				type : 'line'			},			title : {				text : textName			},			xAxis : {				categories : [],				labels : {					rotation : -45,					align : 'right',					style : {						fontSize : '12px',						fontFamily : 'Verdana, sans-serif'					}				}			},			yAxis : {				min:0, // 定义最小值  				title : {					text : yAxisName				}			},			tooltip : {				valueSuffix : yAxisName			},			series : []	});	container2 = $('#container2').highcharts();		//加载图表数据	$.ajax({		"type" : 'post',		"url" : ctx+ '/topicAnalysis/utilizationAnalysis/driverTime.do',		"dataType" : "json",		"data" : {			deptId : deptId,			queryDay : queryDay,			efficiencyType : efficiencyType		},		"success" : function(resp) {			container2Categories = resp["container2"]["categories"];			container2Data = resp["container2"]["data"];			createChart();					}	});}//构造图表function createChart() {	if (typeof (container2Data) != "undefined") {				//更新趋势图数据		var feeTendencySeries = eval(container2Data);		clearChart(container2);		$.each(feeTendencySeries, function(n, value) {			container2.addSeries(value, false);		});		container2.xAxis[0].setCategories(eval(container2Categories),true);	}else{		container2.setTitle( {text: '暂无数据' });	}}//清理原有图层function clearChart(chart) {	var series = chart.series;	while (series.length > 0) {		series[0].remove(false);	}}//---------------------------危险驾驶行为机构热点图  END-------------------------------------------//----------------------------底部列表查询方法 start-------------------------------------------------function query(pageStart) {		var query = serializeArrayByForm('query_utilezation');	if(isNotNull(pageStart)){		query['new_page_start'] = pageStart;	}	query['deptId'] = $("#deptId").val();	query['queryDay'] = $("#queryDay").val();	$('#grid_utilezation').trigger('grid.query', [ query ]);}	function orgGridRenderer(data, idx) {	var trCfg = {		tdList : [			{text : data.RM},			{text : data.DEPT_NAME},			{text : data.MODEL_NAME},			{text : '<a href="javascript:void(0)" onclick="loadReport('+"'"+data.VEHICLE_ID+"'"+')">'+data.VEHICLE_CODE+'</a>'},			{text : data.DRIVER_TIME},			{text : data.LAZY_TIME},			{text : data.MILEAGE},			{text : (data.UTILIZATION*100).toFixed(2)+'%'},			{text : (data.LAZY_RATE*100).toFixed(2)+'%'}		]	}; 	return trCfg;}function loadReport(vehicleId){	openTab('行车报告',ctx+'/resourcesManage/drivingReport/index.do?vehicleId='+vehicleId);}function openTab(name,url){	window.parent.$.fn.jerichoTab.addTab({         tabFirer: null,         title: name,         closeable: true,         data: {             dataType: 'iframe',             dataLink: url         }     }).showLoader().loadData();     resizeTab();}//----------------------------底部列表展示 end---------------------------------------------------//----------------------------------------------------------------//日期查询选择器function selDate(num){		if(null == num || "" == num || 0 == num){		num = 7;	}	$("#queryDay").val(num);			//以下是调用触所有要联动的表图	loadDriverTime();//点火时长趋势图	//机构概况 信息	findDeptDetail();	//运行时长排名加载	drivingRank('container21','vehicle','driveTime');	//怠速时长排名加载	drivingRank('container31','vehicle','lazyTime');	//行驶里程排名加载	drivingRank('container41','vehicle','mileage');	//怠速比率排名加载	drivingRank('container51','vehicle','lazyRatio');	//底部列表	if($("#utilezationList").parent().attr("class")=='active'){		$("#utilezationList").click();	}}//--------------------------- 机构概况信息 start-------------------------------------------function findDeptDetail(){	var deptId = $("#deptId").val();	var isLastDept = $("#isLastDept").val();	var queryDay = $("#queryDay").val();	$.ajax({		"type" : 'post',		"url" : ctx+ '/topicAnalysis/safetyAnalysis/findDeptDetail.do',		"dataType" : "json",		"data" : {			deptId : deptId,			num : queryDay,			isLastDept : isLastDept		},		"success" : function(deptInfo) {			if (typeof (deptInfo) != "undefined") {				$("#VEHICLE_NUMS").html(deptInfo["VEHICLE_NUMS"]);				$("#DRIVER_NUMS").html(deptInfo["DRIVER_NUMS"]);				$("#FAULT_VEHICLE_NUMS").html(deptInfo["FAULT_VEHICLE_NUMS"]);				$("#MILEAGE_TOTAL").html(deptInfo["MILEAGE_TOTAL"]);				$("#DRIVER_TIME_TOTAL").html(deptInfo["DRIVER_TIME_TOTAL"]);				$("#FUEL_TOTAL").html(deptInfo["FUEL_TOTAL"]);								var mil = parseFloat(deptInfo["MILEAGE_TOTAL"]);				var dri = parseFloat(deptInfo["DRIVER_TIME_TOTAL"]);				 if(dri == 0){					 $("#AVG_SPEED").html(0);				 }else{					 $("#AVG_SPEED").html( (mil/dri).toFixed(2) );				 }				findDeptDetailUtili(deptId,queryDay);			}		}	});}function findDeptDetailUtili(deptId,queryDay){	$.ajax({		"type" : 'post',		"url" : ctx+ '/topicAnalysis/utilizationAnalysis/findDeptDetailUtilezation.do',		"dataType" : "json",		"data" : {			deptId : deptId,			num : queryDay		},		"success" : function(deptInfo) {			if (typeof (deptInfo) != "undefined") {				$("#LAZY_DURATION").html(deptInfo["LAZY_DURATION"]);			}		}	});}//--------------------------- 机构概况信息 END-------------------------------------------//---------------------------------运行时长排名 START----------------------------------------function drivingRank(divId,findType,efficiencyType) {      findFuelOrderDate(findType,divId,efficiencyType);    };//拿到点火时长和怠速时长排序数据function findFuelOrderDate(findType,divId,efficiencyType){	var deptId = $("#deptId").val();	var queryDay = $("#queryDay").val();	var url = '';	if(efficiencyType == "lazyRatio"){		url = ctx+ '/topicAnalysis/utilizationAnalysis/findVehLazyRatioData.do';	}else{		url = ctx+ '/topicAnalysis/utilizationAnalysis/findVehDriverTimeData.do';	}			$.ajax({		"type" : 'post',		"url" : url,		"dataType" : "json",		"data" : {			deptId : deptId,			num : queryDay,			findType : findType,			efficiencyType : efficiencyType		},		"success" : function(deptInfo) {			$("#"+divId+" ul").remove();			$("#"+divId).append(' <ul class="list" style="height: 250px;"> </ul>');			if(efficiencyType == "driveTime"){								if (deptInfo != '' && typeof (deptInfo) != "undefined") {					$("#"+divId+" ul").append('<li ><span class="w1">排名</span><span class="w1">车牌</span><span class="w1">点火时长(h/日)</span></li>');					for (var i = 0; i <= deptInfo.length - 1; i++) {						var str = "'"+deptInfo[i]["VEHICLE_ID"]+"'";						$("#"+divId+" ul").append('<li><span class="w1">'+(i+1)+'</span> <span class="w1"><a href="#" onClick="findCarTrajectory('+str+')">'+deptInfo[i]["VEHICLE_CODE"]+'</a> </span> <span  title="'+deptInfo[i]["DRIVER_TIME"]+'" class="w1">'+deptInfo[i]["DRIVER_TIME"]+'</span></li>');					} 				}else{					$("#"+divId+" ul").append('<li style="text-align:center;"><span class="w8" style="float: none;">暂无数据</span></li>');				}							}			if(efficiencyType == "lazyTime"){				if (deptInfo != '' && typeof (deptInfo) != "undefined") {					$("#"+divId+" ul").append('<li ><span class="w1">排名</span><span class="w1">车牌</span><span class="w1">怠速时长(分/日)</span></li>');					for (var i = 0; i <= deptInfo.length - 1; i++) {						var str = "'"+deptInfo[i]["VEHICLE_ID"]+"'";						$("#"+divId+" ul").append('<li><span class="w1">'+(i+1)+'</span> <span class="w1"><a href="#" onClick="findCarTrajectory('+str+')">'+deptInfo[i]["VEHICLE_CODE"]+'</a> </span> <span  title="'+deptInfo[i]["DRIVER_TIME"]+'" class="w1">'+deptInfo[i]["DRIVER_TIME"]+'</span></li>');					} 				}else{					$("#"+divId+" ul").append('<li style="text-align:center;"><span class="w8" style="float: none;">暂无数据</span></li>');				}			}						if(efficiencyType == "mileage"){				if (deptInfo != '' && typeof (deptInfo) != "undefined") {					$("#"+divId+" ul").append('<li ><span class="w1">排名</span><span class="w1">车牌</span><span class="w1">行驶里程(km/日)</span></li>');					for (var i = 0; i <= deptInfo.length - 1; i++) {						var str = "'"+deptInfo[i]["VEHICLE_ID"]+"'";						$("#"+divId+" ul").append('<li><span class="w1">'+(i+1)+'</span> <span class="w1"><a href="#" onClick="findCarTrajectory('+str+')">'+deptInfo[i]["VEHICLE_CODE"]+'</a> </span> <span  title="'+deptInfo[i]["DRIVER_TIME"]+'" class="w1">'+deptInfo[i]["DRIVER_TIME"]+'</span></li>');					} 				}else{					$("#"+divId+" ul").append('<li style="text-align:center;"><span class="w8" style="float: none;">暂无数据</span></li>');				}			}						if(efficiencyType == "lazyRatio"){				if (deptInfo != '' && typeof (deptInfo) != "undefined") {					$("#"+divId+" ul").append('<li ><span class="w1">排名</span><span class="w1">车牌</span><span class="w1">怠速比率</span></li>');					for (var i = 0; i <= deptInfo.length - 1; i++) {						var str = "'"+deptInfo[i]["VEHICLE_ID"]+"'";						$("#"+divId+" ul").append('<li><span class="w1">'+(i+1)+'</span> <span class="w1"><a href="#" onClick="findCarTrajectory('+str+')">'+deptInfo[i]["VEHICLE_CODE"]+'</a> </span> <span  title="'+deptInfo[i]["LAZY_DURATION"]+'" class="w1">'+deptInfo[i]["LAZY_DURATION"]+'</span></li>');					} 				}else{					$("#"+divId+" ul").append('<li style="text-align:center;"><span class="w8" style="float: none;">暂无数据</span></li>');				}			}		}	});}//跳转至行车轨迹function findCarTrajectory(vehicelId){	var rel_url = ctx+ '/resourcesManage/drivingReport/index.do';	openTab('行车报告',rel_url+"?vehicleId="+vehicelId);}//---------------------------------驾驶行为排名 tab页切换 END----------------------------------------//excle导出function exportExcle(){	var deptId = $("#deptId").val();	var queryDay = $("#queryDay").val();	window.location.href=ctx+'/topicAnalysis/utilizationAnalysis/exportVehicleDetail.do?deptId='+deptId+'&queryDay='+queryDay;}