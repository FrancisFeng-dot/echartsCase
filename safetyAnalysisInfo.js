$(function(){ 	var deptId = $("#deptId").val();//初始化当前机构ID	var query_dept = {			deptId : deptId,			fieldtext : "DEPT_NAME",			fieldValue : "DEPT_ID"	}; 	//机构概况信息	findDeptDetail();		//驾驶行为排名	drivingRank('container21','vehicle','threeSharp');	drivingRank('container31','vehicle','slideAlarm');	drivingRank('container41','vehicle','overSpeedAlarm');		//加载 危险驾驶行为机构热点图	loadDangerousDrivingBehavior();		//加载  驾驶行为占比 - 类型占比 饼状图	loadDrivingBehaviorAccounted();		//初始化车辆驾驶行为列表分页	$.grid.init('grid_vehicleBehavior', 'vehicleBehaviorService', vehicle_orgGridRenderer);	//初始化驾驶员驾驶行列表分页	$.grid.init('grid_driverBehavior', 'driverBehaviorService', driver_orgGridRenderer);	//绑定底部车辆驾驶行为列表切换事件	$("#vehicleList").click(function(){					query(null,"query_vehicleBehavior","grid_vehicleBehavior");	});	//绑定底部驾驶员驾驶行列列表切换事件	$("#driverList").click(function(){					query(null,"query_driverBehavior","grid_driverBehavior");	});		//驾驶行为选择器	jQuery(".behaviorType").find(".radio").bind("click", function () {		$(this).addClass("acur").siblings().removeClass("acur");		var radio_val = $("input[name='tab'][type='radio']:checked").val();		$("#typeAlarm").val(radio_val);		//加载 危险驾驶行为机构热点图		loadDangerousDrivingBehavior();	});}); //初始化 chart数据 var container2 = null;var container3 = null;//暂存比例图数据var container2Categories = null;var container3Categories = null;//暂存分析图数据var container2Data = null;var container3Data = null;//---------------------------危险驾驶行为机构热点图 START-------------------------------------------//危险驾驶行为机构热点图 function loadDangerousDrivingBehavior(){	//初始化 危险驾驶行为趋势图	$('#container2').highcharts({			chart : {				type : 'line'			},			title : {				text : ''			},			xAxis : {				categories : [],				labels : {					rotation : -45,					align : 'right',					style : {						fontSize : '12px',						fontFamily : 'Verdana, sans-serif'					}				}			},			yAxis : {				min:0, // 定义最小值  				title : {					text : '次'				}			},			tooltip : {				valueSuffix : '次'			},			series : []	});	container2 = $('#container2').highcharts();	//加载图表数据	loadChartData();}//对图表加载数据function loadChartData() {	var queryDay = $("#queryDay").val();	var behavior = $("#behavior").val();	var deptId = $("#deptId").val();	var typeAlarm = $("#typeAlarm").val();		$.ajax({		"type" : 'post',		"url" : ctx+ '/topicAnalysis/safetyAnalysis/dangerousDrivingBehavior.do',		"dataType" : "json",		"data" : {			deptId : deptId,			queryDay : queryDay,			behavior : behavior,			typeAlarm : typeAlarm		},		"success" : function(resp) {			totelFee = resp["totelFee"];			pieData = resp["pie"];			container2Categories = resp["container2"]["categories"];			container2Data = resp["container2"]["data"];			createChart();					}	});}//构造图表function createChart() {		if (typeof (container2Data) != "undefined") {		container2.setTitle( {text: '危险驾驶行为趋势图' });		//更新趋势图数据		var feeTendencySeries = eval(container2Data);		clearChart(container2);		$.each(feeTendencySeries, function(n, value) {			container2.addSeries(value, false);		});		container2.xAxis[0].setCategories(eval(container2Categories),true);	}else{		container2.setTitle( {text: '暂无数据' });	}}//构造图表function createDBAChart() {		if (container3Data == null){		container3.setTitle( {text: '暂无数据' });}	else if (typeof (container3Data) != "undefined" && container3Data != '') {		//container3.setTitle( {text: '危险驾驶行为占比' });		var feePiedata = eval(container3Data);		//更新饼图数据		container3.series[0].update({			data : feePiedata		});	}else{		container3.setTitle( {text: '暂无数据' });	}}//清理原有图层function clearChart(chart) {	var series = chart.series;	while (series.length > 0) {		series[0].remove(false);	}}//---------------------------危险驾驶行为机构热点图  END-------------------------------------------//--------------------------- 危险驾驶行为占比图  STAST-------------------------------------------// 危险驾驶行为占比图function loadDrivingBehaviorAccounted(){	//初始化 危险驾驶行为占比图	$('#container3').highcharts({		chart : {			plotBackgroundColor : null,			plotBorderWidth : null,			plotShadow : false		},		title : {			text : ''		},		tooltip : {			pointFormat : '{series.name}: <b>{point.percentage:.1f}%</b>'		},		plotOptions : {			pie : {				allowPointSelect : true,				cursor : 'pointer',				dataLabels : {					enabled : true,					color : '#000000',					connectorColor : '#000000',					format : '<b>{point.name}</b>: {point.percentage:.1f} %'				}			}		},		series : [ {			type : 'pie',			name : '所占比例',			data : []		} ]	});	container3 = $('#container3').highcharts();	//加载图表数据	loadDBAChartData();}//对图表加载数据 - 危险驾驶行为占比图function loadDBAChartData() {	var queryDay = $("#queryDay").val();	var deptId = $("#deptId").val();		$.ajax({		"type" : 'post',		"url" : ctx+ '/topicAnalysis/safetyAnalysis/drivingBehaviorAccounted.do',		"dataType" : "json",		"data" : {			deptId : deptId,			queryDay : queryDay		},		"success" : function(resp) {			var objArr = eval(resp.pie);//joson对象转数组			container3Data = null;			for(var i=1;i<objArr.length;i++){				if(objArr[i][1]>0){					container3Data = resp["pie"];					break;					}			}			//container3Data = resp["pie"];			createDBAChart();		}	});}//--------------------------- 危险驾驶行为占比图 END-------------------------------------------//----------------------------------------------------------------//日期查询选择器function selDate(num){		if(null == num || "" == num || 0 == num){		num = 7;	}	$("#queryDay").val(num);			//以下是调用触所有要联动的表图	loadDangerousDrivingBehavior();//危险驾驶行为机构热点图		loadDrivingBehaviorAccounted();//危险驾驶行为占比图		//机构概况信息	findDeptDetail();		//驾驶行为排名	if($("#threeSharpClass").attr("class")=='active'){		$("#threeSharpClass").click();		drivingRank('container21','driver','threeSharp');	}else {		drivingRank('container21','vehicle','threeSharp');	}		if($("#slideAlarmClass").attr("class")=='active'){		$("#slideAlarmClass").click();		drivingRank('container31','driver','slideAlarm');	}else {		drivingRank('container31','vehicle','slideAlarm');	}	if($("#overSpeedAlarmClass").attr("class")=='active'){		$("#overSpeedAlarmClass").click();		drivingRank('container41','driver','overSpeedAlarm');	}else {		drivingRank('container41','vehicle','overSpeedAlarm');	}		//底部列表	if($("#vehicleList").parent().attr("class")=='active'){		$("#vehicleList").click();	}else if($("#driverList").parent().attr("class")=='active'){		$("#driverList").click();	}		}//驾驶行为占比选择器function selAccounted(num){	if(null == num || "" == num || 0 == num){		num = 1;	}	$("#accounted").val(num);		//重新刷类型或机构饼状图	loadDrivingBehaviorAccounted();}//--------------------------- 机构概况信息 start-------------------------------------------function findDeptDetail(){	var deptId = $("#deptId").val();	var isLastDept = $("#isLastDept").val();	var queryDay = $("#queryDay").val();	$.ajax({		"type" : 'post',		"url" : ctx+ '/topicAnalysis/safetyAnalysis/findDeptDetail.do',		"dataType" : "json",		"data" : {			deptId : deptId,			num : queryDay,			isLastDept : isLastDept		},		"success" : function(deptInfo) {			if (typeof (deptInfo) != "undefined") {				$("#VEHICLE_NUMS").html(deptInfo["VEHICLE_NUMS"]);				$("#DRIVER_NUMS").html(deptInfo["DRIVER_NUMS"]);				$("#FAULT_VEHICLE_NUMS").html(deptInfo["FAULT_VEHICLE_NUMS"]);				$("#MILEAGE_TOTAL").html(deptInfo["MILEAGE_TOTAL"]);				$("#DRIVER_TIME_TOTAL").html(deptInfo["DRIVER_TIME_TOTAL"]);				$("#THREESHARP").html(deptInfo["THREESHARP"]);				$("#SLIDE_TIMES").html(deptInfo["SLIDE_TIMES"]);				$("#OVER_SPEED_TIMES").html(deptInfo["OVER_SPEED_TIMES"]);			}		}	});}//--------------------------- 机构概况信息 END-------------------------------------------//---------------------------------驾驶行为排名 tab页切换 START----------------------------------------function drivingRank(divId,findType,typeAlarm) {  	$("#findTypeAlarm").val(findType);        findAlarmOrderDate(findType,divId,typeAlarm);    };//拿到告警排序数据function findAlarmOrderDate(findType,divId,typeAlarm){	var deptId = $("#deptId").val();	var queryDay = $("#queryDay").val();	$.ajax({		"type" : 'post',		"url" : ctx+ '/topicAnalysis/safetyAnalysis/findAlarmOrder.do',		"dataType" : "json",		"data" : {			deptId : deptId,			num : queryDay,			typeAlarm : typeAlarm,			findType : findType		},		"success" : function(deptInfo) {			$("#"+divId+" ul").remove();			$("#"+divId).append(' <ul class="list" style="height: 330px;width: 97%"> </ul>');			if(findType == "vehicle"){								if ( deptInfo  != '' && typeof (deptInfo) != "undefined") {					$("#"+divId+" ul").append('<li ><span class="w1">排名</span><span class="w1">车牌</span><span class="w1">里程(km)</span><span class="w1">点火时长(h)</span><span class="w1">次/日</span></li>');					for (var i = 0; i <= deptInfo.length - 1; i++) {						var str = "'"+deptInfo[i]["VEHICLE_ID"]+"'";						$("#"+divId+" ul").append('<li><span class="w1">'+(i+1)+'</span> <span class="w1"><a href="#" onClick="findCarTrajectory('+str+')">'+deptInfo[i]["VEHICLE_CODE"]+'</a> </span> <span class="w1">'+deptInfo[i]["MILEAGE"]+'</span> <span class="w1">'								+deptInfo[i]["DRIVER_TIME"]+'</span><span class="w1">'+deptInfo[i]["TIMES_ALARM"]+'</span></li>');					} 				}else{					$("#"+divId+" ul").append('<li style="text-align:center;"><span class="w8" style="float: none;">暂无数据</span></li>');				}							}			if(findType == "driver"){				if ( deptInfo != '' && typeof (deptInfo) != "undefined") {					$("#"+divId+" ul").append('<li ><span class="w1">排名</span><span class="w1">司机</span><span class="w1">里程(km)</span><span class="w1">出勤时长(h)</span><span class="w1">次/日</span></li>');					for (var i = 0; i <= deptInfo.length - 1; i++) {						var str = "'"+deptInfo[i]["DRIVER_ID"]+"'";						$("#"+divId+" ul").append('<li><span class="w1">'+(i+1)+'</span> <span class="w1"><a href="#"  onClick="findDriverTrajectory('+str+')">'+deptInfo[i]["DRIVER_NAME"]+'</a> </span> <span class="w1">'+deptInfo[i]["MILEAGE"]+'</span> <span class="w1">'								+deptInfo[i]["DRIVER_TIME"]+'</span><span class="w1">'+deptInfo[i]["TIMES_ALARM"]+'</span></li>');					} 				}else{					$("#"+divId+" ul").append('<li style="text-align:center;"><span class="w8" style="float: none;">暂无数据</span></li>');				}			}		}	});}//跳转至行车轨迹function findCarTrajectory(vehicelId){	var rel_url = ctx+ '/resourcesManage/drivingReport/index.do';	openTab('行车报告',rel_url+"?vehicleId="+vehicelId);}//跳转至驾驶员轨迹 function findDriverTrajectory(driverId){	var rel_url = ctx+ '/resourcesManage/driverDrivingReport/index.do';	openTab('驾驶报告',rel_url+"?driverId="+driverId+"&operation=view");}//---------------------------------驾驶行为排名 tab页切换 END----------------------------------------//------------------------------------分页方法-------------------------------------------------function query(pageStart,form,div) {	var query = serializeArrayByForm(form);	if(isNotNull(pageStart)){		query['new_page_start'] = pageStart;	}	query['deptId'] = $("#deptId").val();	query['queryDay'] = $("#queryDay").val();	$('#'+div).trigger("grid.query", [ query ]);}function vehicle_orgGridRenderer(data, idx) {	var trCfg = {		tdList : [			{text : data.DEPT_NAME},			{text : data.MODEL_NAME},			{text : '<a href="javascript:void(0)" onclick="loadVehicleReport('+"'"+data.VEHICLE_ID+"'"+')" style="font-size: 14px;">'+data.VEHICLE_CODE+'</a>'},			{text : data.DAY_MILEAGE},			{text : data.AVG_SPEED},					{text : data.DAY_SHARP_TIMES},			{text : data.DAY_OVER_SPEED_TIMES},			{text : data.DAY_SLIDE_TIMES}		]	}; 	return trCfg;}function driver_orgGridRenderer(data, idx) {	var trCfg = {		tdList : [			{text : data.DEPT_NAME},			{text : data.EMP_CODE},			{text : '<a href="javascript:void(0)" onclick="loadDriverReport('+"'"+data.STAFF_ID+"'"+')" style="font-size: 14px;">'+data.DRIVER_NAME+'</a>'},			{text : data.DAY_MILEAGE},			{text : data.AVG_SPEED},			{text : data.DAY_SHARP_TIMES},			{text : data.DAY_OVER_SPEED_TIMES},			{text : data.DAY_SLIDE_TIMES}		]	}; 	return trCfg;}function loadVehicleReport(vehicleId){	openTab('行车报告',ctx+'/resourcesManage/drivingReport/index.do?vehicleId='+vehicleId);}function loadDriverReport(driverId){	openTab('行车报告',ctx+'/resourcesManage/driverDrivingReport/index.do?driverId='+driverId);}function openTab(name,url){	window.parent.$.fn.jerichoTab.addTab({         tabFirer: null,         title: name,         closeable: true,         data: {             dataType: 'iframe',             dataLink: url         }     }).showLoader().loadData();     resizeTab();}//excle导出function exportExcle(type){	var deptId = $("#deptId").val();	var queryDay = $("#queryDay").val();	var url = '';		if(type=='vehicle'){		url = ctx+'/topicAnalysis/safetyAnalysis/exportVehicleDetail.do?deptId='+deptId+'&queryDay='+queryDay;	}else if(type=='driver'){		url = ctx+'/topicAnalysis/safetyAnalysis/exportDriverDetail.do?deptId='+deptId+'&queryDay='+queryDay	}	window.location.href=url;}